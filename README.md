# ETL-проект на Python и PostgreSQL

## Описание проекта

Проект состоит из двух частей:

1. **ETL-скрипт для загрузки CSV в PostgreSQL**
2. **ETL-скрипт для создания отчётной витрины (materialized view)**

Обе части используют базу данных **PostgreSQL** и систему логирования для отслеживания выполнения и возможных ошибок.

---

## Стек технологий

- **Python** (`pandas`, `psycopg2`, `SQLAlchemy`)
- **PostgreSQL** (Materialized Views, оконные функции)
- **CSV**
- **Docker Compose**

---

## Структура проекта

├── csv_files/ # Папка с входными CSV-файлами
├── main_etl.py # Скрипт для загрузки CSV в PostgreSQL
├── data_mart.py # Скрипт для создания materialized view
├── sql.sql # SQL-скрипт для создания таблиц и схем
├── docker-compose.yaml # Docker-конфигурация для PostgreSQL
├── presentation1-1.mp4 # Видеопрезентация загрузки CSV
├── presentation1-2.mp4 # Видеопрезентация создания витрины
├── .gitignore # Файл исключений Git
└── logs.etl_log # Таблица логирования (в схеме logs)

---


---

## Часть 1: Загрузка CSV в PostgreSQL

### Как работает скрипт `main_etl.py`:

1. Подключение к базе данных и к базе логов.
2. Определение имени таблицы по имени CSV-файла.
3. Чтение CSV с поддержкой разных кодировок (`utf-8`, `ISO-8859-1`).
4. Автоматическое определение типов данных и столбцов с датами.
5. Проверка наличия уникальных ключей в таблице.
6. Пакетная вставка с использованием `ON CONFLICT DO UPDATE`.
7. Запись всех этапов и ошибок в таблицу `logs.etl_log`.

 **Результат:** все подходящие CSV из папки `csv_files/` автоматически загружаются в базу.

---

## Часть 2: Создание отчётной витрины (Materialized View)

### Как работает скрипт `data_mart.py`:

1. Пользователь вводит дату отчёта (`YYYY-MM-DD`).
2. Подключение к базе данных и к логам.
3. Удаляется старая версия витрины `dm.mv_101_report`, если она существует.
4. Создаётся новая materialized view с расчётами оборотов и балансов.
5. Скрипт сохраняет результаты и пишет в лог успешное завершение или ошибки.

 **Витрина показывает:**

- Дату отчёта
- Обороты по дебету и кредиту
- Сальдо на начало и конец дня для каждого счёта

---

## Логирование

Все шаги обеих ETL-процессов записываются в таблицу `logs.etl_log` со следующими полями:

| Поле       | Описание                                    |
|-----------|---------------------------------------------|
| `log_time` | Дата и время записи события                |
| `severity` | Уровень важности (`INFO`, `WARNING`, `ERROR`) |
| `message`  | Текст события                               |

Логирование помогает контролировать выполнение процессов и быстро находить возможные ошибки.

---

## Демонстрация

-  Загрузка CSV: `presentation1-1.mp4`
-  Создание отчётной витрины: `presentation1-2.mp4`
